#!/bin/bash

. ~/.env

sudo apt install git ssh

if [ $KEY_FILE_NAME ]; then
  FILE_NAME=$KEY_FILE_NAME
else
  read -p "Enter a file name: " FILE_NAME
fi

PRIVATE_FILE=~/.ssh/$FILE_NAME
PUBLIC_FILE=$PRIVATE_FILE.pub

[ ! $(pgrep -x ssh-agent) ] && eval $(ssh-agent -s)

if [ ! -f $PRIVATE_FILE ]; then
  [ ! -d ~/.ssh ] && mkdir .ssh
  ssh-keygen -t ed25519 -C "pikachurando@pm.me" -f $PRIVATE_FILE -P ""
  
  ssh-add $PRIVATE_FILE
fi

HOST=$(hostname)
TITLE="$USER@$HOST"
KEY=$(cat $PUBLIC_FILE)

curl -L \
  -X POST \
  -H "Accept: application/vnd.github+json" \
  -H "Authorization: Bearer $GITHUB_TOKEN" \
  -H "X-GitHub-Api-Version: 2022-11-28" \
  https://api.github.com/user/keys \
  -d "{\"title\":\"$TITLE\", \"key\":\"$KEY\"}"

git clone git@github.com:Billocap/.dotfiles.git ~/.dotfiles

ln -s ~/.dotfiles/.gitconfig ~/.gitconfig

sh ~/.dotfiles/setup
